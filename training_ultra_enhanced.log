Using device: cuda
GPU: NVIDIA L4

============================================================
Loading datasets...
============================================================
Loaded 7424 samples from data/geolife/geolife_transformer_7_train.pk
Vocabulary size: 1187 (unique locations: 1156)
Loaded 3334 samples from data/geolife/geolife_transformer_7_validation.pk
Vocabulary size: 1176 (unique locations: 382)
Loaded 3502 samples from data/geolife/geolife_transformer_7_test.pk
Vocabulary size: 1177 (unique locations: 355)
Train: 7424, Val: 3334, Test: 3502

============================================================
Initializing Ultra-Enhanced HRM...
============================================================
Total parameters: 476,689
✓ Within <500K budget!

Enhancements:
  ✓ Multi-scale temporal attention
  ✓ Hierarchical location embeddings
  ✓ Enhanced temporal embeddings (MLP)
  ✓ EMA training
  ✓ Cosine annealing with restarts
  ✓ Temporal jittering augmentation
  ✓ Label smoothing

============================================================
Training Ultra-Enhanced HRM...
============================================================


============================================================
Epoch 1/600
============================================================
Epoch 1 | Batch 10/78 | Loss: 6.4751 | Acc@1: 0.0938
Epoch 1 | Batch 20/78 | Loss: 5.5743 | Acc@1: 0.1875
Epoch 1 | Batch 30/78 | Loss: 5.3419 | Acc@1: 0.1875
Epoch 1 | Batch 40/78 | Loss: 5.2491 | Acc@1: 0.1771
Epoch 1 | Batch 50/78 | Loss: 5.1849 | Acc@1: 0.1562
Epoch 1 | Batch 60/78 | Loss: 5.6103 | Acc@1: 0.1042
Epoch 1 | Batch 70/78 | Loss: 5.7487 | Acc@1: 0.1458

Validation Results:
  Loss: 6.9458
  Acc@1: 0.0992 (9.92%)
  Acc@5: 0.1163 (11.63%)
  Acc@10: 0.1251 (12.51%)

Test Results:
  Loss: 6.9748
  Acc@1: 0.0814 (8.14%)
  Acc@5: 0.0935 (9.35%)
  Acc@10: 0.1000 (10.00%)

Epoch 1 Summary:
  Train - Loss: 5.6500 | Acc@1: 0.1472
  Val   - Loss: 6.9458 | Acc@1: 0.0992
  Test  - Loss: 6.9748 | Acc@1: 0.0814
  Time: 16.59s | LR: 0.000999
  Params: 476,689
  Saved checkpoint
  ✅ New best validation: 9.92%
  ✅ New best test: 8.14%

============================================================
Epoch 2/600
============================================================
Epoch 2 | Batch 10/78 | Loss: 5.3080 | Acc@1: 0.0938
Epoch 2 | Batch 20/78 | Loss: 5.0169 | Acc@1: 0.1354
Epoch 2 | Batch 30/78 | Loss: 4.9899 | Acc@1: 0.1667
Epoch 2 | Batch 40/78 | Loss: 4.8992 | Acc@1: 0.1771
Epoch 2 | Batch 50/78 | Loss: 4.5315 | Acc@1: 0.2604
Epoch 2 | Batch 60/78 | Loss: 4.5812 | Acc@1: 0.2292
Epoch 2 | Batch 70/78 | Loss: 4.2897 | Acc@1: 0.2396

Validation Results:
  Loss: 6.8064
  Acc@1: 0.1240 (12.40%)
  Acc@5: 0.1872 (18.72%)
  Acc@10: 0.2794 (27.94%)

Test Results:
  Loss: 6.8502
  Acc@1: 0.1019 (10.19%)
  Acc@5: 0.1582 (15.82%)
  Acc@10: 0.2641 (26.41%)

Epoch 2 Summary:
  Train - Loss: 4.8663 | Acc@1: 0.1876
  Val   - Loss: 6.8064 | Acc@1: 0.1240
  Test  - Loss: 6.8502 | Acc@1: 0.1019
  Time: 15.17s | LR: 0.000996
  Params: 476,689
  Saved checkpoint
  ✅ New best validation: 12.40%
  ✅ New best test: 10.19%

============================================================
Epoch 3/600
============================================================
Epoch 3 | Batch 10/78 | Loss: 4.9855 | Acc@1: 0.2083
Epoch 3 | Batch 20/78 | Loss: 4.2214 | Acc@1: 0.2917
Epoch 3 | Batch 30/78 | Loss: 4.5031 | Acc@1: 0.2708
Epoch 3 | Batch 40/78 | Loss: 4.3128 | Acc@1: 0.2500
Epoch 3 | Batch 50/78 | Loss: 4.2125 | Acc@1: 0.2500
Epoch 3 | Batch 60/78 | Loss: 4.5318 | Acc@1: 0.2188
Epoch 3 | Batch 70/78 | Loss: 4.5959 | Acc@1: 0.3333

Validation Results:
  Loss: 6.6787
  Acc@1: 0.1435 (14.35%)
  Acc@5: 0.2369 (23.69%)
  Acc@10: 0.3407 (34.07%)

Test Results:
  Loss: 6.7361
  Acc@1: 0.1227 (12.27%)
  Acc@5: 0.2583 (25.83%)
  Acc@10: 0.3165 (31.65%)

Epoch 3 Summary:
  Train - Loss: 4.5279 | Acc@1: 0.2475
  Val   - Loss: 6.6787 | Acc@1: 0.1435
  Test  - Loss: 6.7361 | Acc@1: 0.1227
  Time: 15.26s | LR: 0.000991
  Params: 476,689
  Saved checkpoint
  ✅ New best validation: 14.35%
  ✅ New best test: 12.27%

============================================================
Epoch 4/600
============================================================
Epoch 4 | Batch 10/78 | Loss: 3.9237 | Acc@1: 0.3542
Epoch 4 | Batch 20/78 | Loss: 3.8383 | Acc@1: 0.3542
Epoch 4 | Batch 30/78 | Loss: 4.3087 | Acc@1: 0.2188
Epoch 4 | Batch 40/78 | Loss: 4.5223 | Acc@1: 0.3333
Epoch 4 | Batch 50/78 | Loss: 4.1481 | Acc@1: 0.2917
Epoch 4 | Batch 60/78 | Loss: 3.9212 | Acc@1: 0.3438
Epoch 4 | Batch 70/78 | Loss: 3.9657 | Acc@1: 0.4062

Validation Results:
  Loss: 6.5619
  Acc@1: 0.1489 (14.89%)
  Acc@5: 0.2450 (24.50%)
  Acc@10: 0.3696 (36.96%)

Test Results:
  Loss: 6.6320
  Acc@1: 0.1320 (13.20%)
  Acc@5: 0.2264 (22.64%)
  Acc@10: 0.3365 (33.65%)

Epoch 4 Summary:
  Train - Loss: 4.2084 | Acc@1: 0.3033
  Val   - Loss: 6.5619 | Acc@1: 0.1489
  Test  - Loss: 6.6320 | Acc@1: 0.1320
  Time: 15.07s | LR: 0.000984
  Params: 476,689
  Saved checkpoint
  ✅ New best validation: 14.89%
  ✅ New best test: 13.20%

============================================================
Epoch 5/600
============================================================
Epoch 5 | Batch 10/78 | Loss: 4.2338 | Acc@1: 0.2708
Epoch 5 | Batch 20/78 | Loss: 4.3476 | Acc@1: 0.3021
Epoch 5 | Batch 30/78 | Loss: 3.9417 | Acc@1: 0.3333
Epoch 5 | Batch 40/78 | Loss: 3.8864 | Acc@1: 0.3125
Epoch 5 | Batch 50/78 | Loss: 3.9068 | Acc@1: 0.3646
Epoch 5 | Batch 60/78 | Loss: 3.9922 | Acc@1: 0.3229
Epoch 5 | Batch 70/78 | Loss: 3.9385 | Acc@1: 0.3958

Validation Results:
  Loss: 6.4552
  Acc@1: 0.1489 (14.89%)
  Acc@5: 0.2496 (24.96%)
  Acc@10: 0.3699 (36.99%)

Test Results:
  Loss: 6.5384
  Acc@1: 0.1376 (13.76%)
  Acc@5: 0.2171 (21.71%)
  Acc@10: 0.3425 (34.25%)

Epoch 5 Summary:
  Train - Loss: 3.9809 | Acc@1: 0.3325
  Val   - Loss: 6.4552 | Acc@1: 0.1489
  Test  - Loss: 6.5384 | Acc@1: 0.1376
  Time: 15.18s | LR: 0.000976
  Params: 476,689
  Saved checkpoint
  ✅ New best validation: 14.89%
  ✅ New best test: 13.76%

============================================================
Epoch 6/600
============================================================
Epoch 6 | Batch 10/78 | Loss: 3.4457 | Acc@1: 0.4271
Epoch 6 | Batch 20/78 | Loss: 3.5901 | Acc@1: 0.3333
Epoch 6 | Batch 30/78 | Loss: 3.6533 | Acc@1: 0.4583
Epoch 6 | Batch 40/78 | Loss: 3.7249 | Acc@1: 0.3750
Epoch 6 | Batch 50/78 | Loss: 3.8388 | Acc@1: 0.4271
Epoch 6 | Batch 60/78 | Loss: 3.8079 | Acc@1: 0.3438
Epoch 6 | Batch 70/78 | Loss: 3.9485 | Acc@1: 0.3021

Validation Results:
  Loss: 6.3574
  Acc@1: 0.1495 (14.95%)
  Acc@5: 0.2535 (25.35%)
  Acc@10: 0.3499 (34.99%)

Test Results:
  Loss: 6.4530
  Acc@1: 0.1421 (14.21%)
  Acc@5: 0.2163 (21.63%)
  Acc@10: 0.3231 (32.31%)

Epoch 6 Summary:
  Train - Loss: 3.8162 | Acc@1: 0.3492
  Val   - Loss: 6.3574 | Acc@1: 0.1495
  Test  - Loss: 6.4530 | Acc@1: 0.1421
  Time: 9.39s | LR: 0.000965
  Params: 476,689
  Saved checkpoint
  ✅ New best validation: 14.95%
  ✅ New best test: 14.21%

============================================================
Epoch 7/600
============================================================
Epoch 7 | Batch 10/78 | Loss: 3.8056 | Acc@1: 0.3646
Epoch 7 | Batch 20/78 | Loss: 3.3491 | Acc@1: 0.3229
Epoch 7 | Batch 30/78 | Loss: 3.6904 | Acc@1: 0.3438
Epoch 7 | Batch 40/78 | Loss: 3.8592 | Acc@1: 0.3542
Epoch 7 | Batch 50/78 | Loss: 3.6288 | Acc@1: 0.3750
Epoch 7 | Batch 60/78 | Loss: 3.5382 | Acc@1: 0.3854
Epoch 7 | Batch 70/78 | Loss: 3.7654 | Acc@1: 0.3333

Validation Results:
  Loss: 6.2659
  Acc@1: 0.1489 (14.89%)
  Acc@5: 0.2540 (25.40%)
  Acc@10: 0.3481 (34.81%)

Test Results:
  Loss: 6.3741
  Acc@1: 0.1441 (14.41%)
  Acc@5: 0.2160 (21.60%)
  Acc@10: 0.2997 (29.97%)

Epoch 7 Summary:
  Train - Loss: 3.6986 | Acc@1: 0.3528
  Val   - Loss: 6.2659 | Acc@1: 0.1489
  Test  - Loss: 6.3741 | Acc@1: 0.1441
  Time: 5.84s | LR: 0.000952
  Params: 476,689
  ✅ New best test: 14.41%

============================================================
Epoch 8/600
============================================================
